# Machine-specific environment variables
# NOTE: Most environment variables and PATH are managed by mise
# See ~/.config/mise/config.toml

{{- if eq .machineId "mac-mini" }}

# Google Cloud SDK (not managed by mise)
if [ -f '/Users/shoji/code/google-cloud-sdk/path.zsh.inc' ]; then
  . '/Users/shoji/code/google-cloud-sdk/path.zsh.inc'
fi
if [ -f '/Users/shoji/code/google-cloud-sdk/completion.zsh.inc' ]; then
  . '/Users/shoji/code/google-cloud-sdk/completion.zsh.inc'
fi

# mise (manages tools, env, aliases)
eval "$(mise activate zsh)"

# databricks configuration
echo fpath+=$(brew --prefix)/share/zsh/site-functions >> ~/.zshrc
echo 'autoload -Uz compinit && compinit' >> ~/.zshrc
export DATABRICKS_CONFIG_PROFILE="DEFAULT"

# Databricks CLI エイリアス
alias dbx="databricks"
alias dbx-lake-prd="DATABRICKS_CONFIG_PROFILE=DEFAULT databricks"
alias dbx-lake-stg="DATABRICKS_CONFIG_PROFILE=lake-stg databricks"
alias dbx-ext-prd="DATABRICKS_CONFIG_PROFILE=external-prd databricks"
alias dbx-ext-stg="DATABRICKS_CONFIG_PROFILE=external-stg databricks"
alias dbx-analysis-prd="DATABRICKS_CONFIG_PROFILE=analysis-prd databricks"
alias dbx-analysis-stg="DATABRICKS_CONFIG_PROFILE=analysis-stg databricks"
alias dbx-terraform="DATABRICKS_CONFIG_PROFILE=terraform databricks"

# 現在のプロファイルを表示
dbx-profile() {
echo "Current Databricks profile: ${DATABRICKS_CONFIG_PROFILE:-DEFAULT}"
}

# プロファイルを切り替える関数
dbx-switch() {
  if [ -z "$1" ]; then
    echo "Usage: dbx-switch <profile-name>"
    echo "Available profiles:"
    echo "  - DEFAULT (lake-prd)"
    echo "  - lake-stg"
    echo "  - external-prd"
    echo "  - external-stg"
    echo "  - analysis-prd"
    echo "  - analysis-stg"
    echo "  - terraform"
    return 1
  fi
  export DATABRICKS_CONFIG_PROFILE=$1
  echo "Switched to profile: $1"
}

# DABバンドルのディレクトリから適切なプロファイルを自動設定
dbx-auto-profile() {
  local current_dir=$(pwd)

  if [[ "$current_dir" == *"/lake/ingest_stg"* ]]; then
    export DATABRICKS_CONFIG_PROFILE="lake-stg"
  elif [[ "$current_dir" == *"/lake/ingest"* ]]; then
    export DATABRICKS_CONFIG_PROFILE="DEFAULT"
  elif [[ "$current_dir" == *"/external/"*"_stg"* ]]; then
    export DATABRICKS_CONFIG_PROFILE="external-stg"
  elif [[ "$current_dir" == *"/external/"* ]]; then
    export DATABRICKS_CONFIG_PROFILE="external-prd"
  else
    echo "Warning: Could not determine appropriate profile for current directory"
    return 1
  fi

  echo "Auto-selected profile: $DATABRICKS_CONFIG_PROFILE"
}

# DABバンドルの一覧を表示
dbx-list-bundles() {
    echo "=== Lake Bundles ==="
    ls -1d ~/Projects/ivry-data-platform-migration/dab/lake/*/ 2>/dev/null | grep -v src
    
    echo -e "\n=== External Bundles ==="
    ls -1d ~/Projects/ivry-data-platform-migration/dab/external/*/ 2>/dev/null | grep -v src
}

# バンドルの状態を確認
dbx-bundle-status() {
    echo "Checking bundle status..."
    databricks bundle validate --target prod
    
    if [ $? -eq 0 ]; then
        echo "✅ Bundle is valid"
        
        # デプロイされているリソースを確認
        echo -e "\nDeployed resources:"
        databricks bundle summary --target prod 2>/dev/null || echo "No deployment found"
    else
        echo "❌ Bundle validation failed"
    fi
}

# ジョブの実行状況を監視
dbx-watch-job() {
    if [ -z "$1" ]; then
        echo "Usage: dbx-watch-job <job-name>"
        return 1
    fi
    
    watch -n 5 "databricks jobs list | grep -A 5 '$1'"
}

# 最近のジョブ実行を表示
dbx-recent-runs() {
    databricks runs list --limit 10 --output json | \
    jq -r '.runs[] | "\(.run_id) | \(.run_name) | \(.state.life_cycle_state) | \(.start_time | strftime("%Y-%m-%d %H:%M"))"' | \
    column -t -s '|'
}


# claude mem
alias claude-mem='/Users/shoji/.bun/bin/bun "/Users/shoji/.claude/plugins/marketplaces/thedotmack/plugin/scripts/worker-service.cjs"'


{{- else if eq .machineId "macbook-air" }}

# mise (manages tools, env, aliases)
eval "$(mise activate zsh)"

{{- else }}

# mise (manages tools, env, aliases)
eval "$(mise activate zsh)"

{{- end }}

