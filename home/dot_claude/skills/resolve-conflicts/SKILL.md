---
name: resolve-conflicts
description: マージコンフリクトを分析し、安全に解決する
allowed-tools: Bash(git status:*), Bash(git diff:*), Bash(git log:*), Bash(git branch:*), Bash(git merge:*), Bash(git rebase:*), Bash(git add:*), Bash(git checkout:*), Read, Grep, Glob
---

## コンテキスト

- 現在のブランチ: !`git branch --show-current`
- マージ/リベースの状態: !`git status`
- コンフリクトのあるファイル: !`git diff --name-only --diff-filter=U 2>/dev/null || echo "コンフリクトなし"`

## タスク

マージコンフリクトを安全かつ正確に解決します。**プランモードを維持したまま分析を行い**、ユーザーの承認後に実際の解決を実行します。

### フェーズ1: 分析（プランモード内 - 読み取り専用）

プランモードを**終了せずに**以下を実行してください。

#### ステップ1: コンフリクトの特定

1. コンフリクトのあるファイルを一覧化する
2. 各ファイルのコンフリクト箇所を特定する（`<<<<<<<`, `=======`, `>>>>>>>` マーカー）
3. コンフリクトの数と影響範囲をまとめる

#### ステップ2: コンフリクトの文脈理解

各コンフリクトについて:

1. **両方のブランチの変更意図を把握する**
   - `git log --oneline HEAD...MERGE_HEAD -- <file>` で各ブランチの関連コミットを確認
   - 各変更の目的を理解する（機能追加、バグ修正、リファクタリングなど）

2. **解決方針を決定する**
   - `ours`: 現在のブランチの変更を採用
   - `theirs`: マージ元の変更を採用
   - `both`: 両方の変更を統合
   - `manual`: 手動で新しい内容を作成

#### ステップ3: 解決方針の提示

以下のフォーマットでユーザーに方針を提示する:

```
## コンフリクト解決方針

### <ファイルパス>
- コンフリクト数: N箇所
- 方針: <ours/theirs/both/manual>
- 理由: <なぜこの方針を選んだか>
- 変更概要: <解決後の内容の概要>
```

#### ステップ4: ExitPlanMode

ユーザーが方針を承認したら、ExitPlanModeで終了してください。

### フェーズ2: 実行（プランモード外）

#### ステップ5: コンフリクトの解決

承認された方針に従い、各ファイルのコンフリクトを解決する:

1. `Read`ツールでファイル全体を読み込む
2. `Edit`ツールでコンフリクトマーカーを含む箇所を解決後の内容に置き換える
3. **コンフリクトのあるファイルのみを変更する**（スコープ厳守）

#### ステップ6: セルフレビュー

解決後に以下を自動検証する:

1. **コンフリクトマーカーの残存チェック**
   - `<<<<<<<`, `=======`, `>>>>>>>` が残っていないことを確認
2. **スコープ外変更の検出**
   - コンフリクトのあったファイル以外に変更がないことを `git diff --name-only` で確認
   - コンフリクト箇所以外に不要な変更がないことを確認
3. **構文チェック**
   - 変更したファイルの言語に応じた構文チェックを実行（可能な場合）

#### ステップ7: ステージング

1. 解決済みファイルを `git add` でステージングする
2. `git status` で最終状態をユーザーに表示する
3. **コミットは実行しない** - ユーザーが `/commit` で実行する

## 制約

- **コンフリクトのあるファイル以外を変更しないこと**
- **コミットを実行しないこと**（ステージングまで）
- **フォーマット修正やリファクタリングを行わないこと** - コンフリクト解決のみに集中する
- コンフリクトの解決方針が不明確な場合は、必ずユーザーに確認する
- 大量のコンフリクト（10ファイル以上）がある場合は、優先順位についてユーザーに相談する

## エッジケース

### リベース中のコンフリクト
`git rebase --continue` はステージング後にユーザーに案内する。自動実行しない。

### バイナリファイルのコンフリクト
バイナリファイルは自動解決せず、ユーザーにどちらを採用するか確認する。

### コンフリクトが存在しない場合
マージ/リベースの状態を確認し、状況をユーザーに報告して終了する。

---

## 参照

### スキル
- [`/commit`](../commit/SKILL.md) - コンフリクト解決後のコミット作成
